# Session Log — 2026-02-25

## Overview
This session introduced a new Day Tour booking type (splitting Viator out of Tours), completely overhauled the Rail extractor to use dedicated CBO Rail screens with one section per segment, added zip file upload support for multi-document rail bookings, fixed two global field naming issues (`gstStatus` → `includegst`; missing fields now use `""` instead of being deleted), and raised token limits to fix a truncation error on large zip uploads.

---

## 1. New Booking Type — Day Tour (Viator)

### Problem
Viator on Line bookings were being classified as `tour`, but the Tour booking type in CBO is reserved for multi-day land packages and all-inclusives. Viator single-day excursions belong in the Misc screens under a new `day_tour` type.

### Implementation
- **`app/agents/extractors/day_tour.py`** — New extractor with `VIATOR_RULES` (8% default commission), Screen 1 (full booking summary) and Screen 2 (one section per individual day tour/activity on the booking).
- **`app/agents/routing_agent.py`** — Added `day_tour` detection signal; annotated Viator row as "bookingType: day_tour — NOT tour".
- **`app/agents/extractors/__init__.py`** — Imported `day_tour_ext`, added `"day_tour": day_tour_ext.run` to `EXTRACTOR_MAP`.
- **`app/agents/extractors/tour.py`** — Removed `VIATOR_RULES` and its `RULE_SET_MAP` entry.
- **`app/main.py`** — Added "Day Tour (Viator)" option to booking type dropdown.

### Field name notes
Day Tours use the Misc screens whose macro reads lowercase property names:
- `clientfeedback` (not `clientFeedback`) — Day-Tours-2 macro
- `agentremarks` (not `agentRemarks`) — both Day-Tours-1 and Day-Tours-2 macros
- `invoiceRemarks` stays camelCase (a typo exists in the macro script itself; our JSON uses the correct spelling)

---

## 2. Rail Extractor Overhaul — Dedicated CBO Rail Screens

### Problem
The old Rail extractor used CBO Misc screens, packing all segment details into a single `clientFeedback` text block. New dedicated Rail screens were set up in CBO with UI.Vision macros (Rail-1.json / Rail-2.json). The extractor needed a full rewrite to match.

### New schema

**Screen 1 (Summary):** reservationDate, vendorName, confirmationNumber, duration, noofpax, noofunits (= segment count, must equal Screen 2 section count), tripType, includegst, totalBase, totalTax, totalCommission, invoiceRemarks, agentRemarks

**Screen 2 (Details) — one section per rail segment:**
serviceProviderName, trainNumber, departCityCode, departCityName, departTerminal, startDate, startTime, arriveCityCode, arriveCityName, arriveTerminal, endDate, endTime, recordLocator, miscellaneous, description, clientFeedback, agentRemarks

City codes (`departCityCode`, `arriveCityCode`) always present as keys — use invoice code → training knowledge → `""` if uncertain. Never omit these keys (macro requires them).

### Key differences from old rail.py
- `commissionAmount` renamed to `totalCommission`
- `invoiceRemarks` and `agentRemarks` added to Screen 1
- Screen 2 is now N structured sections (one per leg), not a single consolidated text block
- `gstStatus` field replaced by `includegst` (see item 5)
- Output pattern mirrors flight segments: sectionTitle `"Rail Screen 2 (Details)"` repeated N times

### Files changed
| File | Change |
|---|---|
| `app/agents/extractors/rail.py` | Complete rewrite |

---

## 3. Email — Segment Numbering for Repeated Section Titles

### Problem
When a booking produces multiple sections with the same title (e.g. 3 × "Rail Screen 2 (Details)"), the email output was hard to navigate — all three looked identical.

### Fix
Modified `_build_html()` to detect duplicate section titles and append a counter suffix to the *display* title only: "Rail Screen 2 (Details) — 1 of 3", "Rail Screen 2 (Details) — 2 of 3", etc. The raw JSON blocks are unaffected — CBO copy-paste still works correctly.

### Files changed
- `app/email_sender.py` — added `display_title` parameter to `_section_html()`; counter logic using `collections.Counter` in `_build_html()`

---

## 4. Zip File Upload Support

### Problem
Rail bookings are often split across multiple files: a supplier booking summary PDF plus individual ticket PDFs (one per passenger per segment). There was no way to submit these together in one pipeline run.

### Fix
Added transparent zip expansion: users can now upload a `.zip` containing any combination of PDF, .eml, and .md files. The zip is unpacked server-side before processing; each inner file becomes a separate pipeline input. macOS metadata (`__MACOSX/`, `.DS_Store`) is silently skipped.

### Files changed
- **`app/main.py`** — added `import io` and `import zipfile`; new `_expand_upload()` helper; `receive_invoice` now calls `files_b64.extend(_expand_upload(...))` instead of `.append()`; form `accept` attribute updated to include `.zip`; form hint text updated.

---

## 5. Rail Prompt Improvements — trainNumber and endTime

### trainNumber
Added detailed guidance for finding the train number in European rail ticket layouts, where it often appears directly below the departure city formatted as `"SERVICE NAME NNNN - N. CLASS"` (e.g. `"INTERCITÉS 3629 - 1. CLASS"` → trainNumber is `"3629"`). Clarified that the train number is never the same as a booking reference, locator, or ticket number.

### endTime
Added explicit direction to check alongside the arrival station name, near seat/coach details, or as the second time in a departure→arrival pair on ticket PDFs. Changed instruction from "OMIT KEY if absent" to "use `""` only if genuinely absent from all source documents."

### Files changed
- `app/agents/extractors/rail.py` — `trainNumber` and `endTime` field descriptions updated

---

## 6. GST Field — Dropdown Values and Key Rename

### Two separate fixes

**Values:** CBO dropdown accepts `"Include GST/HST"` and `"Do Not Include GST/HST"` (not the shorter strings previously used). Updated in both `flight.py` and `rail.py`.

**Key name:** The JSON property name `gstStatus` did not match the actual CBO field ID. Renamed to `includegst` (confirmed from Rail-1-v2.json recording which shows `id=includegst`).

### Files changed
- `app/agents/extractors/flight.py` — `gstStatus` → `includegst` in Seat Screen 1 schema
- `app/agents/extractors/rail.py` — `gstStatus` → `includegst` in Rail Screen 1 schema and explanation block

---

## 7. Global Rule Change — Missing Fields Use `""` Instead of Key Deletion

### Problem
When a JSON key was absent from the extractor output, the UI.Vision macro received `undefined` for that property, which was being typed literally into CBO fields.

### Fix
Changed the global missing-field rule: all fields now use `""` (empty string) when no value is available. Keys are never omitted. Updated `GLOBAL_RULES` in `base.py` and removed all "OMIT KEY if none" annotations from individual schema prompts, replacing them with `use "" if none`. Updated `CLAUDE.md` rule #3.

### Files changed
| File | Change |
|---|---|
| `app/agents/extractors/base.py` | `GLOBAL_RULES` — missing field rule updated |
| `app/agents/extractors/rail.py` | 6 field annotations updated |
| `app/agents/extractors/day_tour.py` | 3 field annotations updated |
| `app/agents/extractors/flight.py` | 1 field annotation updated |
| `CLAUDE.md` | Rule #3 updated |

---

## 8. Bug Fix — Token Truncation on Large Zip Upload

### Symptom
Processing a 1.2 MB Rail Europe zip (booking summary + multiple ticket PDFs) produced:
`Extraction Error: Expecting value: line 1 column 1026 (char 1025)`

### Root cause
Two cascading token limits were too low for a multi-document, multi-segment European rail booking:
1. **markdown_agent.py** — `max_tokens=4096` truncated the raw data extract before all segments were captured, feeding incomplete markdown to Agent 3.
2. **rail.py** — `max_tokens=4096` was insufficient to output the full JSON array for a booking with many segments, each with the new structured per-segment fields.

### Fix
Both limits raised to 8192 (matching the flight extractor).

### Files changed
- `app/agents/markdown_agent.py` — max_tokens 4096 → 8192
- `app/agents/extractors/rail.py` — max_tokens 4096 → 8192

---

## Files Changed This Session

| File | Change |
|---|---|
| `app/agents/extractors/day_tour.py` | New file — Day Tour extractor (Viator) |
| `app/agents/extractors/tour.py` | Removed Viator rules; now multi-day land packages only |
| `app/agents/routing_agent.py` | day_tour detection signal; Viator annotated as day_tour |
| `app/agents/extractors/__init__.py` | day_tour import + EXTRACTOR_MAP entry |
| `app/agents/extractors/rail.py` | Complete rewrite — dedicated CBO Rail screens, N per-segment sections, city codes, trainNumber/endTime guidance, max_tokens 8192 |
| `app/email_sender.py` | Segment counter suffixes on repeated section titles |
| `app/main.py` | Zip upload support; Day Tour dropdown option |
| `app/agents/extractors/base.py` | GLOBAL_RULES — missing fields use "" not key deletion |
| `app/agents/markdown_agent.py` | max_tokens 4096 → 8192 |
| `app/agents/extractors/flight.py` | gstStatus → includegst; "" annotation; dropdown value fix |
| `CLAUDE.md` | Rule #3 updated for "" missing field behaviour |
