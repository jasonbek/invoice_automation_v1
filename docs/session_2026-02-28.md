# Session Log — 2026-02-28

## Overview
This session was focused on rule tweaks and minor corrections — no structural changes to the pipeline. All changes are prompt/instruction updates only.

---

## 1. Vendor Name Correction

### 1a. Rail Europe Official Name Updated
**Change:** Corrected the official vendor name from `Rail Europe` to `Rail Europe Inc` in the routing agent's normalization table.

**Aliases unchanged:** `Eurail`, `Rail Europe`, `The Trainline` — routing still triggers correctly.

**File changed:** `app/agents/routing_agent.py`

---

## 2. Rule Fixes

### 2a. Placeholder `"?"` Now Prohibited (Global)
**Problem:** Claude was occasionally outputting `"?"` in fields where it was uncertain (notably `miscellaneous` and `description` in rail Screen 2), rather than using the required empty string `""`.

**Fix:** Added `"?"` and `"??"` to the list of explicitly banned placeholder values in `GLOBAL_RULES`. Added a reinforcing instruction: "If you are uncertain about a value, use `""` — never use a question mark."

**File changed:** `app/agents/extractors/base.py`

---

### 2b. Viator Confirmation Number Format (BR Prefix)
**Rule added:** `confirmationNumber` for Viator on Line bookings is always the reference beginning with `"BR"` (e.g., `"BR-123456789"`). Individual activity/itinerary numbers are NOT the confirmation number — they belong in `invoiceRemarks`.

**Changes made to `day_tour.py`:**
- Added rule to `VIATOR_RULES` block
- Updated `confirmationNumber` schema description to specify the `BR` prefix
- Updated `invoiceRemarks` schema description to instruct Claude to include individual activity/itinerary numbers there

**File changed:** `app/agents/extractors/day_tour.py`

---

### 2c. Commissions Never Converted to CAD (Global + Per-Extractor)
**Rule:** Commission amounts must always remain in the original invoice currency — they are never converted to CAD. Only `totalBase` (and similar base price fields) are converted.

**Root cause:** The previous wording in `GLOBAL_RULES` said "convert totalBase (and commission where applicable) to CAD", and `tour.py`'s vendor rules and schema field also said commission should be in CAD.

**Changes made:**

| File | Change |
|---|---|
| `app/agents/extractors/base.py` | `GLOBAL_RULES`: removed "and commission where applicable"; added explicit "Do NOT convert commission" instruction |
| `app/agents/extractors/tour.py` | `TRAVEL_BRANDS_RULES`: removed commission from conversion instruction; `commission` schema field: changed from "Amount in CAD" to "Amount in original invoice currency — do NOT convert to CAD" |
| `app/agents/extractors/day_tour.py` | `VIATOR_RULES`: commission calculated on original price in original currency; schema field updated to match |

Note: `cruise.py` was already correct (`totalCommission: "String (in supplier currency)"`). Flight commission is always a percentage or a verbatim ADX dollar figure — no conversion involved.

---

## 3. Investigation — No Cross-Run Memory Issue

**User reported:** A confirmation number from a different client appeared in a rail booking output. Concern raised about whether Claude retains memory between invocations.

**Finding:** No memory issue exists in the code. Every Claude API call is a fresh single-turn conversation (`messages=[{"role": "user", "content": ...}]`). Every `run_pipeline` invocation is an isolated Modal worker with entirely local variables. There is nothing to clear between runs.

**Most likely cause:** Multiple files from different clients/bookings were accidentally included in the same form submission. Rail invoices are intentionally multi-file (booking summary + ticket PDFs), so it is easy to accidentally include a stale ticket PDF from a prior booking. Agent 1 extracts all uploaded files together as a single batch, and the rail extractor is explicitly instructed to cross-reference all source material.

**Resolution:** No code changes needed. Workflow recommendation: verify all uploaded files belong to the same booking before submitting.

---

## Files Changed This Session

| File | Change |
|---|---|
| `app/agents/routing_agent.py` | Official name: `Rail Europe` → `Rail Europe Inc` |
| `app/agents/extractors/base.py` | Banned `"?"` / `"??"` placeholders; commission never converted to CAD |
| `app/agents/extractors/day_tour.py` | Viator BR prefix rule; activity numbers → invoiceRemarks; commission in original currency |
| `app/agents/extractors/tour.py` | Commission stays in original invoice currency (rule + schema field) |
