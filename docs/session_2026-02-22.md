# Session Log — 2026-02-22

## Overview
This session focused on bug fixes found during the first real-world test batch, plus a set of new extraction rules. n8n is now fully retired — the pipeline is self-contained on Modal with a built-in web form and Resend email delivery.

---

## 1. Bug Fixes

### 1a. Passenger Name Always "Unknown"
**Root cause:** The regex in `_extract_traveller_name()` expected labels like `Passenger:` or `Guest:`, but AMA Waterways invoices output `Passenger Name 1:` — the number between "Name" and the colon broke the match.

**First fix:** Updated regex to `(?:\d+)?` to absorb the number. Worked for that invoice, but the user correctly identified this as a fragile approach — hundreds of suppliers will use different labels.

**Final fix (correct approach):**
- Instructed Agent 1 (markdown_agent.py) to **always output the label `Passenger:`** for every traveller/guest/client/pax name, regardless of what the invoice calls them.
- Simplified the regex in `_extract_traveller_name()` to just `r"(?im)^Passenger:\s*(.+)$"` — one label, always consistent.
- Now Claude's language understanding handles the variation; the regex is a simple, reliable lookup.

**Files changed:** `app/agents/markdown_agent.py`, `app/main.py`

---

### 1b. Double Email (Double Form Submission)
**Root cause:** After clicking "Process Invoice", the browser showed raw JSON — no confirmation page, no button disable. Easy to click twice or re-submit accidentally.

**Fix:** Added JavaScript to the form that:
1. Immediately disables the submit button and changes text to "Submitting…"
2. After 800ms, hides the form and shows a confirmation screen: "✓ Invoice submitted successfully. Results will arrive by email in about 30–60 seconds."
3. Provides a "Submit another invoice" link to reload the form clean.

**File changed:** `app/main.py` (inline HTML in `_FORM_HTML`)

---

### 1c. Original Invoice Not Attached to Email
**Feature added:** The original invoice file(s) are now passed through as Resend email attachments, unchanged. Useful for comparing the original against the extracted output during testing.

**Implementation:** Added `attachments: list[dict] | None = None` parameter to `send_results()`. Files from `files_b64` are passed directly — Resend accepts base64 content natively.

**Files changed:** `app/email_sender.py`, `app/main.py`

---

## 2. New Rules

### 2a. Today's Date as Booking Date Fallback (All Booking Types)
**Problem:** Some invoices don't include an explicit booking/reservation date. Previously, Claude would either hallucinate a date or leave the field missing.

**Solution:**
- Added to `GLOBAL_RULES` in `base.py`: "If no booking or reservation date appears on the invoice, use the TODAY'S DATE value provided in the input."
- `today_date = date.today().strftime("%m/%d/%y")` is computed once in `__init__.py` before the `asyncio.gather()` call.
- Injected as `TODAY'S DATE: MM/DD/YY` into the `user_content` of every extractor.
- Follows the same pattern as `exchange_rate_note`.

**Files changed:** `app/agents/extractors/base.py`, `app/agents/extractors/__init__.py`, and all six extractor `run()` signatures: `flight.py`, `tour.py`, `hotel.py`, `cruise.py`, `insurance.py`, `new_traveller.py`

---

### 2b. Expedia TAAP Hotel Rules (New)
**Problem:** Expedia TAAP hotel invoices display a "Room price / Subtotal" that already includes taxes. Using it directly as `baseAmount` would be wrong.

**Rules added to `hotel.py` as `EXPEDIA_RULES`:**
- `baseAmount` = Subtotal − Taxes & fees (e.g., $1,402.02 − $127.44 = $1,274.58)
- `taxAmount` = "Taxes & fees" line only
- "Due at property" / city/local tax → NOT in `taxAmount`, noted in `notesForClient` instead
- Commission → look for "Total Earnings" label (Expedia TAAP uses this instead of "Commission")

**Architecture change:** `hotel.py` was converted from a single static prompt to the vendor rule template pattern (same as `flight.py` and `tour.py`), enabling per-vendor rules via `RULE_SET_MAP`.

**Files changed:** `app/agents/extractors/hotel.py`

---

### 2c. Promotions and Savings in Client Remarks (Global)
**Rule added to `GLOBAL_RULES`:** Any special deal, promotional discount, loyalty reward, price reduction, or savings amount MUST always be noted in the client-facing remarks field:
- Flights, tours, cruises → `invoiceRemarks`
- Hotels → `notesForClient`

Example format: `"Special deal applied: 15% off (CA $224.91 savings)"`

**File changed:** `app/agents/extractors/base.py`

---

### 2d. Hotel "Due at Property" in Client Notes (All Hotels)
**Rule added:** Any "Due at property", "City tax", or "Local tax" line on any hotel invoice:
- Must NOT be added to `taxAmount`
- Must be noted in `notesForClient` as: `"Due at property: CA $X.XX (city/local tax)"`

Applied to both `EXPEDIA_RULES` and `GENERIC_HOTEL_RULES` in `hotel.py`, and to the `notesForClient` schema description.

**File changed:** `app/agents/extractors/hotel.py`

---

## 3. Deployment Status

- **n8n: fully retired.** The pipeline is self-contained.
- **Production URL:** `https://jasonbekdashe--invoice-processor-fastapi-entrypoint.modal.run/form`
- **Modal secrets confirmed active:** `anthropic` (ANTHROPIC_API_KEY), `resend` (RESEND_API_KEY, FROM_EMAIL, TO_EMAIL)
- **Status:** Bookmarked and ready for 20-invoice test batch.

---

## Files Changed This Session

| File | Change |
|---|---|
| `app/agents/markdown_agent.py` | Added rule: always output `Passenger:` label for all traveller names |
| `app/main.py` | Regex simplified; form confirmation screen + button disable; `attachments` passed to email |
| `app/email_sender.py` | Added `attachments` parameter; original files sent as Resend email attachments |
| `app/agents/extractors/base.py` | Added: today's date fallback rule, promotions/savings rule |
| `app/agents/extractors/__init__.py` | Compute `today_date`; pass to all extractors alongside `exchange_rate_note` |
| `app/agents/extractors/flight.py` | Added `today_date` param + injection |
| `app/agents/extractors/tour.py` | Added `today_date` param + injection |
| `app/agents/extractors/hotel.py` | Full rewrite to vendor-rule template pattern; EXPEDIA_RULES; due-at-property rule |
| `app/agents/extractors/cruise.py` | Added `today_date` param + injection |
| `app/agents/extractors/insurance.py` | Added `today_date` param + injection |
| `app/agents/extractors/new_traveller.py` | Added `today_date` param (signature only) |
