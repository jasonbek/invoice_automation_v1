# Session Log — 2026-02-24

## Overview
This session focused on diagnosing and fixing a recurring flight extraction error, a series of flight and service fee schema improvements, a new Rail booking type, and a data quality rule for tour itineraries.

---

## 1. Bug Fix — Extraction Error on WestJet Flights

### Symptom
Email showed `Extraction Error: Expecting value: line 1 column 1 (char 0)` for WestJet invoices, particularly when two PDFs were uploaded for one booking.

### Root cause (confirmed via Modal logs)
`stop_reason='end_turn'`, `content_length=3530` — Claude was returning 3530 characters of content that began with prose (e.g. a preamble before the JSON array). The original `^`-anchored regex in `call_claude()` only stripped a code fence if it was at the very start of the string, so any preamble caused `json.loads` to fail at character 0.

### Fixes applied

**`app/agents/extractors/base.py`**
- Replaced anchored `re.sub` regex stripping with `re.search` to find and extract content from a code fence *anywhere* in the response.
- Added fallback: if no code fence found and raw string doesn't start with `[`, skip to the first `[` to bypass any prose preamble.
- Added structured error logging on `JSONDecodeError` (stop_reason, content_length, ASCII-safe preview of raw response).

**`app/agents/markdown_agent.py`**
- Increased `max_tokens` from 2048 → 4096 to handle two PDFs worth of invoice data without truncation.

**`app/agents/extractors/flight.py`**
- Increased `max_tokens` from 4096 → 8192 to handle larger JSON output (multiple segments + passengers from two PDFs).

---

## 2. Flight Screen 1 — Conditional Fields by Vendor

### Change
For **Air Canada Internet, Westjet Internet, and ADX**, `totalBase`, `totalTax`, and `totalCommission` are no longer output in Flight Screen 1 (Summary). These amounts are already entered per-passenger in Flight Screen 3 (the ticketing section in ClientBase), making the totals on Screen 1 redundant.

For all other vendors (Tourcan, Expedia, generic), Screen 1 still includes all three total fields.

### Implementation (`app/agents/extractors/flight.py`)
- Added `_TICKETING_VENDORS = {"air_canada", "westjet", "adx_intair"}` set.
- Added two Section 1 schema constants: `_SECTION1_SUMMARY_ONLY` (no totals) and `_SECTION1_FULL` (with totals).
- Added `{section1_schema}` placeholder to `_SYSTEM_PROMPT_TEMPLATE`.
- `run()` selects the correct schema based on `rule_set` at call time.
- Updated Section 3 field descriptions to be self-contained (no cross-references to Section 1 totals).

---

## 3. Flight Screen 3 — Ticket Number Prefix Strip

### Change
Ticket numbers in Flight Screen 3 (Passengers) now strip the first 3 digits (the airline code prefix).

Example: `0141234567890` → `1234567890`

### Implementation (`app/agents/extractors/flight.py`)
- Updated `ticketNumber` field description in Section 3 schema with an explicit example.

---

## 4. Flight — Seat Charge Screens (Conditional Sections 4 & 5)

### Change
When a flight invoice includes explicit seat selection charges (with a dollar amount), the flight extractor now appends two additional sections after Screen 3:

- **Seat Screen 1 (Summary):** reservationDate, vendorName, confirmationNumber, duration, noofpax, noofunits, tripType, totalBase, totalTax (if present), commissionAmount (always "0%"), gstStatus
- **Seat Screen 2 (Details):** serviceProviderName, startDate, endDate, description ("Seat Selection Fees — [seat list from invoiceRemarks]")

If no seat charges are present, output remains exactly 3 sections.

### UI.Vision macro fix required
Both `Seats-1-Revised` and `Seats-2-Revised` macros must have `[0]` removed from their `executeScript_Sandbox` Target line. Seat screen data is a plain object `{...}`, not an array — `[0]` on a plain object returns `undefined`.

**Before:** `...return JSON.parse(cleanedString)[0];`
**After:** `...return JSON.parse(cleanedString);`

### Implementation (`app/agents/extractors/flight.py`)
- Added Sections 4 & 5 schema block to `_SYSTEM_PROMPT_TEMPLATE` with conditional output rules.
- Updated OUTPUT FORMAT comment to show 3 or 5 sections depending on seat charges.
- Updated `user_content` instruction to mention the 3-or-5 section count.

---

## 5. Service Fee Fixes

### 5a. `chargedAs` field
Changed from `"Per Booking"` → `"Total"` to match the valid ClientBase dropdown values (Total / Per Person). Service fees are always charged as a combined total regardless of passenger count.

### 5b. Screen 2 dates now use trip dates
Screen 2 `startDate` and `endDate` previously always defaulted to today's date. They now reflect the actual trip dates extracted from the invoice, with today as fallback if dates cannot be determined.

### Implementation (`app/agents/extractors/service_fee.py`)
- Replaced `_get_pax_count()` (single-field Claude call) with `_get_invoice_context()` (returns `{noofpax, startDate, endDate}` in one call — no additional API cost).
- `run()` now uses extracted `startDate`/`endDate` with `today` as fallback.

---

## 6. New Booking Type — Rail

Rail bookings (VIA Rail, Amtrak, Eurostar, Rail Europe, etc.) are entered in ClientBase as Miscellaneous bookings. A new extractor produces 2 sections using the same field set as the seat charge screens, with `clientFeedback` for the segment itinerary.

### Screen 1 (Summary) fields
reservationDate, vendorName, confirmationNumber, duration, noofpax, noofunits (= segment count), tripType (Domestic/Transborder/International), totalBase, totalTax (if present), commissionAmount (default "0%"), gstStatus

### Screen 2 (Details) fields
serviceProviderName, startDate, endDate, description ("Rail"), clientFeedback

`clientFeedback` format — one line per segment:
```
[Origin Station] -> [Destination Station] | [Date] | Train: [Service/Train#] | Ticket: [Ticket#] | Ref: [Ref#]
```

### Files changed
| File | Change |
|---|---|
| `app/agents/extractors/rail.py` | New file — full extractor with GENERIC_RAIL_RULES |
| `app/agents/extractors/__init__.py` | Import + `"rail": rail_ext.run` in EXTRACTOR_MAP |
| `app/agents/routing_agent.py` | Rail detection signal; VIA Rail, Amtrak, Eurostar, Rail Europe added to vendor normalization table; generic ruleSet note updated |
| `app/main.py` | "Rail / Train" added to booking type dropdown |

---

## 7. Tour `clientFeedback` — Financial Data Exclusion Rule

### Problem
Commission amounts were appearing inside the `clientFeedback` itinerary text on tour extractions.

### Fix
Added an explicit exclusion to the `clientFeedback` field description in both `tour.py` and `rail.py`:

> "DO NOT include any pricing, commission, deposit amounts, or financial figures — those belong in Screen 1 only."

### Files changed
- `app/agents/extractors/tour.py`
- `app/agents/extractors/rail.py`

---

## Files Changed This Session

| File | Change |
|---|---|
| `app/agents/extractors/base.py` | Robust JSON extraction from prose-prefixed responses; structured error logging |
| `app/agents/markdown_agent.py` | max_tokens 2048 → 4096 |
| `app/agents/extractors/flight.py` | Conditional Screen 1 fields; ticket prefix strip; seat charge sections 4 & 5; max_tokens 4096 → 8192 |
| `app/agents/extractors/service_fee.py` | chargedAs "Total"; Screen 2 trip dates from invoice; consolidated Claude call |
| `app/agents/extractors/rail.py` | New file — Rail extractor (2 sections) |
| `app/agents/extractors/__init__.py` | Rail import + EXTRACTOR_MAP entry |
| `app/agents/routing_agent.py` | Rail detection signal; 4 rail vendor aliases |
| `app/main.py` | Rail / Train option in form dropdown |
| `app/agents/extractors/tour.py` | clientFeedback financial data exclusion rule |
